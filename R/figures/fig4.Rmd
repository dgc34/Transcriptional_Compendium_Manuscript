---
title: "fig4"
author: "Daniel Chawla"
date: "3/18/2022"
output: md_document
---

#Figure 4: Existing signatures of bacterial and viral infection are generally robust when evaluated in independent data

Robustness is evaluated using `analysis/calc_robustness_crossreactivity.R`


Initialization:

```{r}
library(dplyr)
library(ggplot2)
library(stringr)
library(openxlsx)
library(ggridges)

source('../analysis/plot_palette.R')
```

Plotting: 

```{r, include = F, echo = F}
input_file <- '~/Dropbox/big_eval_heatmap_list_generalizability_030422_NA_sbj_ts.RDS'

# apply signature ordering for plotting
sig_order <- lapply(c('VxB', 'V', 'B'), function(x){
  paste0(x, 1:15)}) %>%
  unlist()

plotGenDf <- function(input_df, text_flag = T, AUC_threshold = 0.6){
  color_dat <- input_df %>%
    group_by(Signature) %>%
    summarize('med' = median(Scores)) %>% # find the fraction of values below this point
    arrange(med) %>%
    mutate('Specificity' = factor(ifelse(med <= AUC_threshold, 'not robust', 'robust'))) %>% # label signatures with more than 25% of their values above the threshold red
    dplyr::select(-med)
  color_vals <- c("#FFFFFF", "gray50")#, "#0072B2", "#D55E00", "#009E73", "#E69F00", "#56B4E9", "#F0E442")
  shape_vals <- c(8, 3, 4, 16, 17)
  names(shape_vals) <- unique(outlier.studies$Accession)
  names(color_vals) <- c('robust', 'not robust')
  #cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
  
  #color_vals <- c('black', 'red3')
  
  
  text_df <- input_df %>%
    group_by(Comparison, Signature) %>%
    summarize('sig_med' = median(Scores)) %>%
    ungroup() %>%
    group_by(Comparison) %>%
    summarize('comp_med' = median(sig_med), 'N_sigs' = n()) %>%
    mutate(Signature = N_sigs/1.6) %>%
    mutate(Scores = 0.3) %>%
    mutate(plot_label = paste0('median AUC: ', round(comp_med, 2)))
  
  input_df <- input_df %>%
    left_join(color_dat)
  
  text_geom <- theme()
  if(text_flag){
    text_geom <- geom_text(data = text_df, aes(label = plot_label, color = NULL)) 
  } 
  
  pout <- ggplot(input_df %>% 
                   mutate(Signature = factor(Signature, levels = gsub(pattern = 'x', replacement = '/', x = sig_order), ordered = T)) %>%
                   mutate(Comparison = factor(Comparison, levels = c('V/B', 'Virus', 'Bacteria'), ordered = T)), 
                 aes(x = Signature, y = Scores)) + 
    geom_boxplot(outlier.shape = NA, aes(fill = Specificity, alpha = 0.5)) + 
    geom_point(data = input_df %>% filter(Pt.Color != ''), aes(shape = Pt.Color)) + 
    #text_geom +
    geom_hline(yintercept = c(AUC_threshold), color = 'red', linetype = 'dashed') + 
    geom_hline(yintercept = c(0.5), color = 'black', linetype = 'dashed') + 
    facet_grid(. ~ Comparison, scales = 'free', space = 'free') + 
    scale_shape_manual(values = shape_vals, name = 'Outlier Points') + 
    scale_fill_manual(values = color_vals[1:2], name = 'Performance') + 
    scale_alpha(guide = 'none') +
    theme_clean + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1),
          legend.position = 'right',
          panel.spacing = unit(2, "lines")) + 
    scale_y_continuous(breaks = seq(to = 1, from = 0, by = 0.1), limits = c(0,1)) + 
    labs(y = 'AUC') 
  
  #ggsave(fname, width = 8, height = 5, dpi = 300)
  return(list(input_df, pout))
}
```

## 4A-C: Robustness of V, B, and V/B signatures
```{r}
gen_df <- readRDS(input_file) %>%
  bind_rows() %>%
  filter(!grepl(pattern = 'I', x = Signature)) %>% 
  mutate(Comparison = str_extract(string = Signature, pattern = 'VxB|V|B')) %>%
  mutate(Comparison = factor(Comparison, levels = c('VxB', 'V', 'B'), labels = c('VxB', 'Virus', 'Bacteria'), ordered = T)) %>%
  mutate(Signature = factor(x = Signature, levels = sig_order, ordered = T))

contrast <- str_extract(pattern = 'healthy|noninf|orig', string = input_file)

# update discovery/validation annotations
modified_disc <- read.xlsx('../tables/supp_1.xlsx') %>%
  filter(grepl(pattern = 'GSE73072', x = Discovery.Accessions))

# update discovery/validation labels
for (sig in 1:nrow(modified_disc)){
  signature_row <- modified_disc[sig, ]
  sdys <- str_split(signature_row$Discovery.Accessions, pattern = ';') %>% unlist()
  gen_df <- gen_df %>%
    mutate(Type = ifelse((Signature == signature_row$Signature.Label & Study %in% sdys), 'Discovery', Type))
}

gen_df <- gen_df %>%
  filter(N > 4) %>%
  mutate(Signature = str_replace(pattern = 'VxB', replacement = 'V/B', string = Signature)) %>% 
  mutate(Comparison = str_replace(pattern = 'VxB', replacement = 'V/B', string = Comparison)) 

# filter to non-discovery
nondisc_df <- gen_df %>%
  filter(Type %in% c('Validation', 'New'))

# format for plotting
color_vals <- c('#F2BE84', '#C4E8F0', '#8FD0BA', 'gray50')
names(color_vals) <- c('B', 'V', 'V/B', 'not robust')
sig_order <- c(
  paste0('V', 1:11), paste0('B', 1:7), paste0('V/B', 1:7)
) %>% rev()

# color distributions according to threshold
AUC_threshold <- 0.7
color_dat <- nondisc_df %>%
    group_by(Signature) %>%
    summarize('med' = median(Scores)) %>% # find the fraction of values below this point
    arrange(med) %>%
    mutate('Specificity' = factor(ifelse(med <= AUC_threshold, 'not robust', 'robust'))) %>% # label signatures with more than 25% of their values above the threshold red
    dplyr::select(-med)

# format data for plotting
plot_dat <- nondisc_df %>% 
  left_join(color_dat) %>% 
  mutate(Comparison = ifelse(Comparison == 'Bacteria', 'B', Comparison)) %>% 
  mutate(Comparison = ifelse(Comparison == 'Virus', 'V', Comparison)) %>%
  mutate(Comparison = factor(Comparison, levels = c("V", "B", "V/B"), ordered = T)) %>%
  mutate(Signature = factor(Signature, levels = sig_order, ordered = T)) %>%
  mutate(Specificity = ifelse(Specificity == 'robust', as.character(Comparison), 'not robust'))

op1 <- ggplot(plot_dat, aes(x = Scores, y = Signature, fill = Specificity)) +
  #geom_vline(xintercept = AUC_threshold, color = 'red', linetype = 'dashed') + 
  #geom_vline(xintercept = 0.5, color = 'black', linetype = 'dashed') + 
  #geom_density_ridges(stat = 'binline', binwidth = 0.05) +
  geom_density_ridges() +
  facet_grid(Comparison ~ ., space = 'free', scales = 'free') +
  scale_fill_manual(values = color_vals) +
  xlim(c(0,1)) + 
  labs(x = 'AUC') +
  theme_clean +
  theme(legend.position = 'none')

op1

```

## 4D-E Robustness for HIV and B. Pseudomallei infection

HIV and B. pseudomallei performance was evaluated separately using `analysis/calc_robustness_crossreactivity.R` 
and datasets from the compendium containing these pathogens with healthy controls

```{r, include = FALSE, echo = FALSE}
hiv_input_file <- '~/Dropbox/hiv_eval_heatmap_list_generalizability_021422_healthy_sbj_ts.RDS'

bps_input_file <- '~/Dropbox/bp_eval_heatmap_list_generalizability_021422_healthy_sbj_ts.RDS'
```

```{r}
AUC_threshold <- 0.7

sig_order <- rev(c(paste0('V', 1:15), paste0('B', 1:10)))

plot_dat_hiv <- readRDS(hiv_input_file) %>%
  bind_rows() %>%
  mutate(Signature = factor(Signature, levels = sig_order, ordered = T)) %>% 
  group_by(Signature) %>% 
  mutate(med = median(Scores)) %>%
  ungroup() %>% 
  mutate('Specificity' = factor(ifelse(med <= AUC_threshold, 'not robust', 'V'))) %>% # label signatures with more than 25% of their values above the threshold red
  #dplyr::select(-med) %>%
  filter(grepl(pattern = 'V', x = Signature))

plot_dat_hiv %>%
  filter(Signature != 'V3') %>%
  group_by(Signature) %>%
  summarize('med' = median(Scores)) %>%
  pull(med) %>%
  summary()

plot_dat_bps <- readRDS(bps_input_file) %>%
  bind_rows() %>% 
  mutate(Signature = factor(Signature, levels = sig_order, ordered = T)) %>% 
  group_by(Signature) %>%
  mutate(med = median(Scores)) %>%
  ungroup() %>% 
  mutate('Specificity' = factor(ifelse(med <= AUC_threshold, 'not robust', 'B'))) %>% # label signatures with more than 25% of their values above the threshold red
  dplyr::select(-med)
color_vals <- c('#F2BE84', '#C4E8F0', '#8FD0BA', 'gray50')
names(color_vals) <- c('B', 'V', 'V/B', 'not robust')#"#0072B2", "#D55E00", "#009E73", "#E69F00", "#56B4E9", "#F0E442")
#names(color_vals) <- c('robust', 'not robust')

noninf_bps_df <- readRDS('~/Dropbox/bp_eval_heatmap_list_generalizability_021422_noninf_sbj_ts.RDS') %>%
  bind_rows() %>% 
  mutate(Signature = factor(Signature, levels = sig_order, ordered = T)) %>% 
  group_by(Signature) %>%
  mutate(med = median(Scores)) %>%
  ungroup() %>% 
  mutate('Specificity' = factor(ifelse(med <= AUC_threshold, 'not robust', 'B'))) %>% # label signatures with more than 25% of their values above the threshold red
  dplyr::select(-med)

plot_dat_bps %>%
  filter(!Signature %in% c('B1')) %>%
  group_by(Signature) %>%
  summarize('med' = median(Scores)) 

genPlot <- function(df, title_str){
  plot_grob <- df %>%
    ggplot(aes(y = Signature, x = Scores, fill = Specificity)) + 
    geom_boxplot() +
    theme_clean + 
    xlim(0, 1) + 
    scale_fill_manual(values = color_vals) +
    #geom_vline(xintercept = 0.5, linetype = 'dashed', color = 'black') +
    #geom_vline(xintercept = AUC_threshold, linetype = 'dashed', color = 'red') + 
    theme(legend.position = 'none') + 
    labs(x = 'AUC', title = title_str)
  
}

#dlims <- layer_scales(op3[[2]])$y$range_c$range[2]

p4d <- genPlot(plot_dat_hiv, 'HIV datasets') #+ scale_y_discrete(expand= expansion(add = c(0.1,0.2)))
p4d <- p4d + scale_y_discrete(expand = expansion(mult = c(0.07, .14)))
p4e <- genPlot(plot_dat_bps, 'B. pseudomallei datasets') + 
  scale_y_discrete(expand = expansion(mult = c(0.1, .2)))


p4d/p4e
```

## 4F Mycoplasma performance 
```{r, echo = F, include = F}
library(MetaIntegrator)
MIobj <- readRDS('~/Dropbox/GSE103119.RDS')
table(MIobj$pheno$Pathogen)
table(MIobj$pheno$Class)
p <- MIobj$pheno
p <- p %>%
  mutate('Gram' = ifelse(grepl(pattern = 'Mycoplasma', x = Pathogen), 'Negative', 'Positive')) %>%
  mutate('Gram' = ifelse(`bacterial organism:ch1` %in% c('N/A', 'NONE'), NA, Gram)) %>%
  mutate('Gram' = ifelse(grepl(pattern = '+', x = `bacterial organism:ch1`, fixed = T), 'Mixed', Gram))
table(p$Class, p$Gram)
table(p$`bacterial organism:ch1`, p$Gram)
rownames(p) <- rownames(MIobj$pheno)
MIobj$pheno <- p
checkDataObject(MIobj, 'Dataset')
```

```{r}
library(ggpubr)
library(tidyr)
source('../analysis/helperFunctions.R')
source('../analysis/plot_palette.R')

signatures_file <- '../tables/supp_1.xlsx'
signatures <- read.xlsx(signatures_file)

# helper function to parse dataset into just gram pos / just gram neg
repairIndex <- function(index){
  ix <- is.na(index)
  index[ix] <- F
  return(index)
}

# make 3 versions of GSE103119 depending on gram stain
data_list <- list()
index_pos <- repairIndex((p$Gram == 'Positive' & p$Class %in% c('Bacteria')) | p$Class %in% c('Virus'))
index_neg <- repairIndex((p$Gram == 'Negative' & p$Class %in% c('Bacteria')) | p$Class %in% c('Virus'))
index_both <- repairIndex((p$Gram %in% c('Positive', 'Negative') & p$Class == 'Bacteria') | p$Class %in% c('Virus'))

# make metaIntegrator objects for each index
MIobj_positive <- filterMIobj(MIobj, index_pos)
MIobj_negative <- filterMIobj(MIobj, index_neg)
MIobj_both <- filterMIobj(MIobj, index_both)

# barplot of subjects for positive and negative gram stains
signatures <- signatures %>%
  filter(Type == 'VxB')
nrow(signatures)

# parse Signatures for scoring
filterObjs <- list()
for(i in 1:nrow(signatures)){
  filterObjs[[i]] <- sig2Meta(signatures[i,])
}

# score datasets and format for plotting
score_df <- sapply(filterObjs, FUN = calculateScore, datasetObject = MIobj_both) %>%
  cbind()
signature_names <- sapply(filterObjs, function(x){return(x$filterDescription)}) 
colnames(score_df) <- signature_names
score_df <- score_df %>%
  as.data.frame()

# plot
plot_dat <- MIobj_both$pheno %>%
  dplyr::select(geo_accession, Pathogen, Class, Gram) %>%
  bind_cols(score_df) %>%
  reshape2::melt(id.vars = c('geo_accession', 'Pathogen', 'Class', 'Gram'), value.name = 'Score', variable.name = 'Signature') %>%
  mutate(Gram = ifelse(is.na(Gram), '', Gram)) %>%
  mutate(Infection = ifelse(Class == 'Virus', 'Virus', NA)) %>%
  mutate(Infection = ifelse(Gram == 'Positive', 'Gram positive bacteria', Infection)) %>%
  mutate(Infection = ifelse(Gram == 'Negative', 'Mycoplasma', Infection)) %>%
  mutate(Infection = factor(Infection, levels = c('Gram positive bacteria', 'Virus', 'Mycoplasma'), ordered = T))

signature_labels <- unique(plot_dat$Signature)

plot_dat2 <- plot_dat %>%
  mutate('Signature' = factor(Signature, level = signature_labels, ordered = T)) %>%
  mutate('xl' = factor(Infection, levels = c('Gram positive bacteria',
                                               'Mycoplasma', 
                                               'Virus'), 
                         labels = c('+', '-', 'vir'), 
                         ordered = T)) %>%
  group_by(Signature) %>%
  summarize('+' = auroc(bool = (xl == 'vir'), score = Score), '-' = auroc(bool = (xl == 'vir')[xl != '-'], score = Score[xl != '-'])) %>%
  pivot_longer(names_to = 'Type', values_to = 'AUC', cols = !Signature)

p4f <- ggplot(plot_dat2 %>% mutate(Comparison = 'V/B'), aes(x = Type, y = AUC, fill = Comparison)) + 
  geom_boxplot() + 
  geom_point() + 
  #geom_vline(xintercept = 0.5, linetype = 'dashed', color = 'black') + 
  scale_fill_manual(values = color_vals) +
  stat_compare_means(paired = T, method = 'wilcox.test', position = position_nudge(y = -0.85, x = 0.4)) + 
  ylim(c(0,1)) + 
  coord_flip() + 
  labs(title = 'Mycoplasma', x = 'Included in Cohort') + 
  theme(axis.text.y = element_text(size = 20)) + 
  theme_clean + 
  theme(legend.position = 'none')
p4f

```

## 4G: Male vs female performance

Data lists were created for infectious conditions using `analysis/imputing_sex.R`
Performance in males and females was evaluated for each signature using `analysis_calc_robustness_crossreactivity.R`

```{r, include = F, echo = F}
male <- readRDS('~/Dropbox/male_eval_heatmap_list_generalizability_021422_healthy_sbj_ts.RDS')
female <- readRDS('~/Dropbox/female_eval_heatmap_list_generalizability_021422_healthy_sbj_ts.RDS')
# plot male vs female along with correlations?
```

```{r}
male_df <- bind_rows(male) %>%
  #mutate('Imputed.Sex' = 'male') %>%
  dplyr::select(Study, Signature, Type, Scores, N) %>%
  dplyr::rename('Male.Scores' = Scores, 'Male.N' = N)
female_df <- bind_rows(female) %>%
  #mutate('Imputed.Sex' = 'female') %>%
  dplyr::select(Study, Signature, Type, Scores, N) %>%
  dplyr::rename('Female.Scores' = Scores, 'Female.N' = N)


sig_order <- c(paste0('VxB', 1:7), paste0('V', 1:12), paste0('B', 1:9))
plot_df <- male_df %>%
  left_join(female_df) %>%
  mutate('Comparison' = str_extract(pattern = 'VxB|V|B', string = Signature)) %>%
  mutate(Signature = factor(Signature, levels = sig_order, ordered = T)) 

mini_df <- plot_df %>%
  group_by(Comparison, Signature) %>%
  summarize('Male.AUC' = median(Male.Scores, na.rm = T), 'Female.AUC' = median(Female.Scores, na.rm = T)) %>%
  ungroup() %>%
  mutate(Comparison = gsub(pattern = 'VxB', replacement = 'V/B', x = Comparison))

lm_eqn <- function(df){
  m <- lm(Female.AUC ~ Male.AUC, df);
  # eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2, 
  #                  list(a = format(unname(coef(m)[1]), digits = 2),
  #                       b = format(unname(coef(m)[2]), digits = 2),
  #                       r2 = format(summary(m)$r.squared, digits = 3)))
  eq <- substitute(~~italic(r)^2~"="~r2, 
                   list(r2 = format(summary(m)$r.squared, digits = 3)))
  as.character(as.expression(eq));
}


p4g <- ggplot(mini_df, aes(x = Male.AUC, y = Female.AUC)) + 
  geom_text(x = 0.65, y = 0.85, color = 'black', label = lm_eqn(mini_df), parse = TRUE) + 
  geom_point(pch = 21, fill = 'gray50') + 
  xlim(c(0.5,1)) + 
  ylim(c(0.5, 1)) + 
  scale_fill_manual(values = color_vals, name = '') + 
  geom_abline(slope = 1, intercept = 0, linetype = 'dashed', color = 'gray50') + 
  labs(x = 'Male median AUC', y = 'Female median AUC') +
  theme_clean +
  theme(legend.position = 'none')
p4g
```

## 4F: Acute vs. chronic infections
```{r, include = F, echo = F}
library(stringr)

gen_df <- readRDS('~/Dropbox/big_eval_heatmap_list_generalizability_021322_healthy_sbj_ts.RDS') %>%
  bind_rows() %>%
  #filter(Type == 'Discovery') %>%
  mutate(Comparison = str_extract(string = Signature, pattern = 'VxB|V|B')) %>%
  mutate(Comparison = factor(Comparison, levels = c('VxB', 'V', 'B'), labels = c('VxB', 'Virus', 'Bacteria'), ordered = T)) %>%
  mutate(Signature = factor(Signature, levels = sig_order, ordered = T)) %>%
  filter(N > 4) %>%
  filter(Comparison != 'VxB', !TS)
```

```{r}
# get acute and chronic labels, filter data to labeled studies
ann <- read.xlsx('../tables/acute_chronic_labels.xlsx')
study_plot_dat <- gen_df %>%
  left_join(ann)
study_plot_dat %>%
  filter(is.na(Time)) %>%
  dplyr::select(Study, Comparison) %>%
  distinct()

# summarize medians per signature and acute/chronic labels
fig4e_plot_dat <- study_plot_dat %>%
  group_by(Signature, Time, Comparison) %>% # group by study so each observation is a signature
  filter(Comparison == 'Virus', Time != 'Acute & Chronic', Signature != 'V9') %>% # remove V9 because there are no chronic datasets with this control group
  summarize(Scores = median(Scores, na.rm = T)) %>% # find the median signature scores
  mutate(Time = factor(Time, levels = c('Acute', 'Chronic', 'Acute & Chronic'), ordered = T))

p4h <- ggplot(fig4e_plot_dat,
             aes(x = Time, y = Scores)) +
  theme_clean + 
  geom_boxplot() +
  #facet_grid(. ~ Signature, space = 'free', scales = 'free') +
  #facet_grid(. ~ Comparison, space = 'free', scales = 'free') + 
  stat_compare_means(method = 'wilcox.test', position = position_nudge(x = 0.2, y = -0.02)) +
  theme(axis.text.x = element_text(angle= 90, hjust = 1)) +
  geom_hline(yintercept = 0.5, color = 'black', linetype = 'dashed') +
  geom_hline(yintercept = AUC_threshold, color = 'red', linetype = 'dashed') + 
  scale_y_continuous(breaks = seq(to = 1, from = 0.5, by = 0.1), limits = c(0.45,1.05)) + 
  labs(y = 'Average Dataset AUC', x = 'Infection Timing')
p4h
```


## 4I: Symptom severity
```{r, include = F, echo = F}
input_file <- '~/Dropbox/GSE73072_v1.RDS'
```


```{r}
# load viral signatures
signatures_file <- '../tables/supp_1.xlsx'
signatures <- read.xlsx(signatures_file) %>%
  filter(Type == 'Virus') 

# GSE73072 has detailed symptom information across 7 cohorts
accessions_of_interest <- 'GSE73072'
if(!file.exists(input_file)){
  data_list <- readRDS('../../data_list_final/data_list_v1.RDS')
  keep_ix <- grepl(pattern = paste(accessions_of_interest, collapse = '|'), x = names(data_list))
  data_list <- data_list[keep_ix]
  saveRDS(object = data_list, file = input_file)
} else {
  data_list <- readRDS(input_file)
}

names(data_list)

# generate scores for each signature and each subject
## format class vector
data_list <- data_list %>%
  lapply(function(MIobj){
    MIobj$class <- as.numeric(MIobj$pheno$Class == 'Virus')
    names(MIobj$class) <- rownames(MIobj$pheno)
    if(checkDataObject(MIobj, 'Dataset')){
      return(MIobj)
    } else {
      stop()
    }
  })
## calculate AUROCs
full_df <- list()
for(i in 1:nrow(signatures)){
  current_sig <- sig2Meta(signatures[i,])
  score_df <- lapply(data_list, function(MIobj){
    df <- MIobj$pheno %>%
      dplyr::select(SubjectID, Time.Point, Symptoms, Class) %>%
      mutate('Score' = calculateScoreRobust(datasetObject = MIobj, filterObject = current_sig, method = 'geomMean', zScore = F)) %>%
      mutate('Study' = MIobj$formattedName, 'Signature' = current_sig$filterDescription)
    return(df)
  })
  full_df[[i]] <- score_df %>% bind_rows()
}
plot_dat <- bind_rows(full_df) %>%
  mutate(Signature = factor(Signature, levels = paste0('V', 1:15), ordered = T))

## verify that asymptomatic individuals still demonstrate an increase in viral signature scores
## compared to baseline (requires z-scoring for facet grid. could facet wrap, but relative changes are preserved either way)
plot_dat_scaled <- plot_dat %>%
  group_by(Signature, Study) %>%
  mutate(Score = scale(Score)) %>%
  mutate(N = n())


### AUCs asymptomatic vs symptomatic
# take the maximum value over time for Virus and Healthy
summarized_dat <- plot_dat %>%
  group_by(SubjectID, Study, Signature, Symptoms, Class) %>%
  summarize('Max' = max(Score)) %>%
  ungroup() %>%
  group_by(SubjectID, Study, Signature, Symptoms) %>%
  mutate(N = n()) %>%
  filter(N == 2)

N_dat <- plot_dat %>%
  filter(Signature == 'V1') %>%
  dplyr::select(SubjectID, Study, Signature, Symptoms) %>%
  distinct() %>%
  group_by(Study, Signature, Symptoms) %>%
  summarize('N' = n()) %>%
  group_by(Study) %>%
  summarize('N' = min(N))

stat_studies <- N_dat %>%
  filter(N >= 4) %>%
  pull(Study)

auc_dat <- summarized_dat %>%
  filter(Study %in% stat_studies) %>%
  group_by(Symptoms, Study, Signature) %>%
  summarize('AUC' = auroc(bool = Class == 'Virus', score = Max))

study_lab <- 'DEE5'

AUC_threshold = 0.7
auc_plot_dat <- auc_dat %>%
  mutate(Symptoms = ifelse(Symptoms, 'symptomatic', 'asymptomatic')) %>%
  mutate(Symptoms = factor(Symptoms, levels = c('symptomatic', 'asymptomatic'), ordered = T)) %>% 
  mutate(Study = ifelse(grepl(pattern = 'DEE3', x = Study), 'H1N1 cohort 1', Study)) %>% 
  mutate(Study = ifelse(grepl(pattern = 'DEE4', x = Study), 'H1N1 cohort 2', Study)) %>% 
  mutate(Study = ifelse(grepl(pattern = 'HRV', x = Study), 'hRV cohort 3', Study))
symp_colors <- c('gray 80', 'white')
names(symp_colors) <- c('symptomatic', 'asymptomatic')
p4i <- ggplot(auc_plot_dat %>%
                filter(grepl(pattern = 'cohort 3', x = Study)), aes(x = Symptoms, y = AUC)) + 
  #geom_line(aes(group = Signature),color = 'gray80') + 
  geom_boxplot(outlier.shape = NA) + 
  #geom_point(aes(shape = Study), position = position_jitter(width = 0.1, height = 0, seed = 0208)) +
  #geom_point(aes(shape = Study)) +
  geom_point() + 
  #ylim(c(0.5, 1)) +
  #geom_line(aes(group = Signature),color = 'gray50', position = position_jitter(width = 0.1, height = 0, seed = 0208)) +
  
  scale_fill_manual(values = symp_colors) + 
  theme_clean + 
  theme(legend.title = element_blank(), legend.position = 'bottom')  + 
  labs(x = '') + 
  #facet_grid(. ~ Study, scales = 'free', space = 'free') + 
  scale_y_continuous(breaks = seq(to = 1, from = 0.5, by = 0.1), limits = c(0.45,1.05)) + 
  geom_hline(yintercept = 0.5, color = 'black', linetype = 'dashed') +
  geom_hline(yintercept = AUC_threshold, color = 'red', linetype = 'dashed') + 
  theme(strip.placement = 'none') + 
  stat_compare_means(method = 'wilcox.test', paired = T, position = position_nudge(y = -0.025))
p4i

```

